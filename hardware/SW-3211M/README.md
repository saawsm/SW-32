# SW-3211M, a MK-312 style driver on a stick!
<img align="center" width="600" src="doc/SW-3211M.png">

## About:
This board aims to bring the hardware of e-stim/TENS to an easy-to-use module. Think: Sparkfun, Adafruit, etc.

This device tries to mimic the output stage of the well-known Erostec ET312 or better, the DIY reverse engineered MK-312.
Hopefully by recreating this output stage, the same e-stim experience can be achieved as those devices.

Its been designed around the ESP-32 microcontroller (hence SW-32), but should work with others. 

The original design of this module was based on the design by [WendyTeslaburger/WT-312](https://github.com/WendyTeslaburger/WT-312).

## Project status:
- ðŸ”² Create v1.0 Schematic
- ðŸ”² Route v1.0 PCB
- ðŸ”² Review
- ðŸ”² Fix BOM with (available) alternative sources 
- ðŸ”² Order v1.0 PCBs

## Theory of operation:
### Output stage:
<img align="right" width="350" src="doc/output_stage.png">
Just like the ET/MT312 this stick uses a 42TL004 audio transformer with the primary connected to the TENS output and the secondary connected to some circuitry to generate pulses.

These pulses are generated by the microcontroller, it can control frequency (how many pulses per second) and the duration of each pulse.

A single "pulse"  consists of two steps:
1. Apply a voltage on A-signal. This will make one of both N-FETs conductive and current will start to flow through half the windings of the transformer.
2. Apply a voltage on the B-signal. This will make current flow through the other half of the transformer and reverse the polarity of the output TENS signal. Thus making this a bi-polar TENS driver.

To prevent the an excessive high drain-source voltage on the N-MOS drivers because of back-EMF generated by the transformer, two diodes will clamp this voltage to a zener diode on top of the centre-tap voltage.

### Level control:
<img align="right" width="350" src="doc/level_control.png">
The intensity of a TENS stimulus is not only defined by the duration and frequency of the pulses, but also by the output power of that pulse. To control the output power of a pulse, we can limit how much current is flowing into the primary side of the transfomer.

By controlling the gate-voltage of a P-FET it is possible to control how much current that P-FET will allow to flow. An opamp is used to boost the I/o-voltage of the microcontroller to the 9V needed on the P-FET gate.

Important is to note that the LVL signal is inverted, a 0V means the P-FET is allowing maximal current and a 3.3V/5V will mean the P-FET is turned off.

### Current feedback:
<img align="right" width="300" src="doc/current_sense.png">
Because not all P-FET are created 100% equally, it is important to first characterize the transfer curve between the LVL-signal and the current flowing through the transformer. This curve can be measured by the MCU on a embedded or external 
ADC on the *I_FB* pin of the WT-312 module.

To keep the voltage lost over the shunt resistor to a minimum, a small value shunt resistor is used and then amplified to the full-range of the ADC by an opamp.